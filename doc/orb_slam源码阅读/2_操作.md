# 初始化
## 单目初始化
## 双目初始化
# 前端
|操作|用途|步骤|数据量|其他|
|--|----|---|---|---|
|关键帧跟踪|1.地图刚初始化后；<br> 2.恒速跟踪失败 <br> 3.上一帧进行重定位跟踪过|1. bow计算 <br> 2. 通过bow搜索相似特征点对应的地图点( < 125 失败>)  <br> 3.位姿计算（内点数>10 成功） <br>|上一个关键帧<br>通过bow进行关键点全量搜索 <br> 匹配点距离少于50 |可能失败，失败后进行重定位跟踪|
|恒速跟踪|上一帧跟踪成功|1. 更新地图（位姿和双目相机创建临时地图点）<br> 2. 匹配 3. 位姿优化|1. 通过重投影搜索附近地图点，距离小于100|-|
|重定位跟踪|1. 上一帧跟踪失败，地图重置|1.从keyFrame 中挑选关键帧（基于bow中相同的单词，相当严格，doc/orb_slam源码阅读/1_数据结构.md） <br> 2. |-|-|
|局部地图跟踪|1. 用于上述地图粗定位后的精定位|1. 通过共视点与更多关键帧建立关系 <br> 2. 将关键帧的地图点尝试投影到当前帧，得到更多的地图点 <br> 3. 位姿优化 4. 通过内点判断是否成功|1. 有共同地图点所有关键帧（若< 80, 则其共视关系好的，父子关键帧>）<br> 2. 关键帧的地图点查找，基于Bow节点（非单词）（<15个,一个候选帧失败）<br> 3. 使用Pnp求解和关键帧相对位姿  <br> 4. 通过g2o优化位姿(内点 < 15 失败 > 50成功)，<br> 5. 搜索更多的匹配点， 重新优化 内点 > 50成功|1. 计算量很大 </br> |
# 后端
## 建图
### 创建关键帧
1. 初始化时
2. 追踪时
影响因子
- 当前系统可以插入关键帧，见localmap
- 追踪到的关键点较少,外点较多
- 系统空闲程度
``` c++
  // Condition 1a: More than "MaxFrames" have passed from last keyframe insertion
    const bool c1a = mCurrentFrame.mnId>=mnLastKeyFrameId+mMaxFrames;
    // Condition 1b: More than "MinFrames" have passed and Local Mapping is idle(空闲)
    const bool c1b = (mCurrentFrame.mnId>=mnLastKeyFrameId+mMinFrames && bLocalMappingIdle);
    //Condition 1c: tracking is weak
    const bool c1c =  mSensor!=System::MONOCULAR && (mnMatchesInliers<nRefMatches*0.25 || bNeedToInsertClose) ;
    // Condition 2: Few tracked points compared to reference keyframe. Lots of visual odometry compared to map matches.
    const bool c2 = ((mnMatchesInliers<nRefMatches*thRefRatio|| bNeedToInsertClose) && mnMatchesInliers>15);

    if((c1a||c1b||c1c)&&c2)
    {
        // If the mapping accepts keyframes, insert keyframe.
        // Otherwise send a signal to interrupt BA
        if(bLocalMappingIdle)
        {
            return true;
        }
        else
        {
            mpLocalMapper->InterruptBA();
            if(mSensor!=System::MONOCULAR)
            {
                if(mpLocalMapper->KeyframesInQueue()<3)
                    return true;
                else
                    return false;
            }
            else
                return false;
        }
    } 
```
建图之后，非单目相机建立地图点，至少建立100个。
### 局部建图中对关键帧的操作
主要函数 LocalMapping::ProcessNewKeyFrame() 见数据结构，localmap

## 局部优化
# 回环检测
## 检测
## 优化

- [x]周一跟踪相关
- []周二初始化
- []周三局部建图
- []周四回环检测



