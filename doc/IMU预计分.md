# IMU预积分
IMU预积分主要目的是将频率很高的IMU数据累加。等到其他数据到达后，进行融合。
预计分用到的主要是运动学和李代数的知识。李代数主要使用了一阶近似和伴随性质。
# 问题引出
## 李群视角下的运动学
### 旋转矩阵，角速度
$$
\dot{R} = Rw^{\Lambda} (w瞬时速度) \\
\Delta{R} = Exp(w^{\Lambda} \Delta t)) (瞬时变换，有上式解的)\\
R = R_0 * Exp(w^{\Lambda} \Delta t) 
$$
### 线速度
先考虑一个问题，相机坐标系下的速度如何转为世界坐标系下的速度。如果没有旋转：$ v_w = Rv_c$
如果有旋转呢？ 根据$p_w = R_{wc}p_c + t$，可以得到：$v_w = Rv_c + w \times (Rp_0 + t)$
$$
p_1 = R_{12}p_2 + t  \\
分别对R和p求导 关于时间的导数\\
v_1 = \dot{p_1} = R_{12}v_c + R_{12}w^{\Lambda} p_2 = R_{12} (v_2 + w^{\Lambda}p_2)\\
$$
补充：
p1，p2指什么，v1，v2指什么？ 上述公式有什么物理意义？ 与我们关注的车的速度有什么关系？
- 如果车辆不发生转动，则v1和v2是同一个向量在不同坐标系的转换。如果车辆
发生转动，则不是同一个向量。
- 采用微分的思想，将p当作车辆的位置，v_2车辆的t时刻的瞬时速度（相对于***上一个时刻***车辆坐标系下，该坐标系在一小段时间内是静止的）v2由轮速记提供或者通过IMU计算。
- 实时情况下，在车辆坐标系下，车辆速度始终为0。 
- 下一个车辆坐标系的变换可通过车辆速度计算。

### 线性加速度
对v求导：
$$
a_1 = \dot{v_1} = \dot{R}_{12}（v_2 + w^{\Lambda} p_2） + R_{12} (\dot{v_2} + \dot{w}^{\Lambda} p_2 + w^{\Lambda}\dot{p_2})  \\  = R_{12}w^{\Lambda}(v_2 + w^{\Lambda} p_2) + R_{12}(\dot{v_2} + \dot{w}^{\Lambda} p_2 +  w^{\Lambda}\dot{p_2}) \\ = R_{12} (\dot{v_2} + 2w^{\Lambda} v_2 + \dot{w}^{\Lambda} p_2 + w^{\Lambda} w^{\Lambda} p_2) 
$$
运动中一般舍弃后3项。

## 问题
上述公式中，都是根据商议时刻的值估计当前时刻的值。当IMU数据频率很高时，基于$R_0$, R不断更新，如果优化过程中$R_0$被更新，那么基于$R_0$的估计值就需要重新计算。 当IMU频率很高时，这种计算方式效率较低。缺乏灵活性。

## 解决思路
将$R_0$从公式中排除。计算一段时间（其他传感器的频率）的累加值。 即IMU在一段时间内独立计算，也就是IMU预计分。

## 如何做
字母上方由~的表示可以直接从IMU中读取或者计算，没有的为实际值。
### 原始模型
![alt text](image-6.png)
![alt text](image-7.png)
### 将之前的状态变量移除
![alt text](image-8.png)
### 将观测到的变量和不确定误差分离
![alt text](image-9.png)
### 计算上述过程中的噪声模型（并递推为累加模式）
![alt text](image-10.png)
### 零偏的更新
一般情况下不会发生或者很小。上述模型中，当零偏发生时需要重新计算。此处用一阶展开代替。并写成递推模式
![alt text](image-11.png)

至此完成了图优化的分解

## 基于图优化的使用
![alt text](image-12.png)
残差的定义，考虑原始模型中如何提取状态无关变量。 
![alt text](image-13.png)


考虑如何使残差减少。
上述残差模型决定了雅可比矩阵的数量。
### 雅可比矩阵
雅可比矩阵主要用于优化$R_i,R_j,V_i,V_j,P_i,P_j$这些变量，求解过程中预计分不发生改变（零偏变化，预计分要变化）。 所以要求残差对$R_i,R_j,V_i,V_j,P_i,P_j$的导数。
- R的残差对$R_i,R_j$的导数
![alt text](image-14.png)
- 对$b_g&
![alt text](image-15.png)
实际使用中，考虑是否要优化$b_g&
- v速度的残差对$V_i,V_j, R_i$的导数
![alt text](image-16.png)
-  v速度的残差对$ b_a, b_g$的导数（取负号），因为$b_a,b_g与\delta v_{ij}$有关

![alt text](image-17.png)

- P对$b_a, b_g$的导数(取负号)

![alt text](image-18.png)
- P对$V_i,p_i,p_j,R_i$的导数

![alt text](image-19.png)